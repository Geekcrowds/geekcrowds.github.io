<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­å® V3 - å¤šå­—åº“å­¦ä¹ ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }

        .chinese-text {
            font-family: 'Noto Sans SC', sans-serif;
        }

        /* Flip Card Animation */
        .flip-card {
            perspective: 1000px;
            cursor: pointer;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1rem;
        }

        .flip-card-back {
            transform: rotateY(180deg);
        }

        /* Confetti Animation */
        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 1000;
            animation: confetti-fall 3s linear forwards;
        }

        /* Smooth Transitions */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Character Animation */
        .char-pop {
            animation: charPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes charPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        /* Quiz option hover effect */
        .quiz-option {
            transition: all 0.2s ease;
        }
        .quiz-option:hover:not(.correct-answer):not(.wrong-answer) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .correct-answer {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            animation: pulse 0.5s ease;
            color: white !important;
        }

        .wrong-answer {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            animation: shake 0.5s ease;
            color: white !important;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Library selector */
        .library-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .library-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .library-card.active {
            border-color: #a855f7;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }

        /* Stroke order animation */
        .stroke-order {
            font-size: 120px;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">

    <!-- Main Container -->
    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="inline-block">
                <h1 class="text-5xl font-black chinese-text mb-2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
                    æ±‰è¯­å® V3
                </h1>
                <p class="text-gray-600 text-sm mb-2">å¤šå­—åº“æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ Â· Multi-Library Learning System</p>
                <div class="flex gap-2 justify-center items-center text-xs text-gray-500 flex-wrap">
                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">ğŸ“š HSKè€ƒè¯•</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">ğŸ“– å°å­¦è¯­æ–‡</span>
                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded">ğŸ¯ è‡ªå®šä¹‰å­—åº“</span>
                </div>
            </div>
        </header>

        <!-- Library Selection Modal (shown first time or when changing library) -->
        <div id="libraryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200">
                    <h2 class="text-2xl font-bold text-gray-800 chinese-text">é€‰æ‹©å­¦ä¹ å­—åº“</h2>
                    <p class="text-gray-600 text-sm mt-1">é€‰æ‹©é€‚åˆæ‚¨çš„å­¦ä¹ å†…å®¹</p>
                </div>
                
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-4" id="libraryList">
                    <!-- Libraries will be injected here -->
                </div>
                
                <div class="p-6 border-t border-gray-200 bg-gray-50">
                    <button onclick="closeLibraryModal()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium">
                        å¼€å§‹å­¦ä¹ 
                    </button>
                </div>
            </div>
        </div>

        <!-- Current Library Info Banner -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-2xl" id="currentLibraryIcon">
                        ğŸ“š
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 chinese-text" id="currentLibraryName">HSKè¯æ±‡</h3>
                        <p class="text-xs text-gray-500" id="currentLibraryDesc">å›½é™…æ±‰è¯­æ°´å¹³è€ƒè¯•è¯æ±‡</p>
                    </div>
                </div>
                <button onclick="showLibraryModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>åˆ‡æ¢å­—åº“
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">ä»Šæ—¥å­¦ä¹ </div>
                <div class="text-2xl font-bold text-purple-600" id="todayCount">0</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">å·²æŒæ¡</div>
                <div class="text-2xl font-bold text-green-600" id="masteredCount">0</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">è¿ç»­æ‰“å¡</div>
                <div class="text-2xl font-bold text-orange-600" id="streakCount">0</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">æ€»è¯æ±‡é‡</div>
                <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 p-2">
            <div class="flex gap-2">
                <button onclick="switchTab('learn')" id="tab-learn" class="flex-1 px-6 py-3 rounded-lg font-medium transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                    <i class="fas fa-book-open mr-2"></i>å­¦ä¹ å¡ç‰‡
                </button>
                <button onclick="switchTab('quiz')" id="tab-quiz" class="flex-1 px-6 py-3 rounded-lg font-medium transition-all text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-question-circle mr-2"></i>è¶£å‘³æµ‹éªŒ
                </button>
                <button onclick="switchTab('stats')" id="tab-stats" class="flex-1 px-6 py-3 rounded-lg font-medium transition-all text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-chart-bar mr-2"></i>å­¦ä¹ ç»Ÿè®¡
                </button>
            </div>
        </div>

        <!-- Level Filter (Dynamic based on library) -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6" id="filterSection">
            <!-- Filter will be injected based on current library -->
        </div>

        <!-- Learning Section -->
        <section id="learn-section" class="fade-in">
            <!-- Flash Card -->
            <div class="max-w-2xl mx-auto">
                <div class="flip-card h-96 mb-6" id="flashCard" onclick="flipCard()">
                    <div class="flip-card-inner h-full">
                        <!-- Front -->
                        <div class="flip-card-front bg-white shadow-xl p-8 flex flex-col items-center justify-center">
                            <div class="text-8xl mb-4 chinese-text char-pop stroke-order" id="cardCharacter">ä½ å¥½</div>
                            <div class="text-2xl text-gray-600 mb-2" id="cardPinyin">nÇ hÇo</div>
                            <div class="text-sm text-gray-400">ç‚¹å‡»ç¿»è½¬æŸ¥çœ‹å«ä¹‰</div>
                        </div>
                        <!-- Back -->
                        <div class="flip-card-back bg-gradient-to-br from-purple-500 to-pink-500 text-white shadow-xl p-8 flex flex-col justify-center">
                            <div class="text-3xl font-bold mb-4" id="cardEnglish">Hello</div>
                            <div class="text-lg mb-4 chinese-text" id="cardExample">ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ã€‚</div>
                            <div class="text-sm opacity-90 mb-4" id="cardExampleEn">Hello! Nice to meet you.</div>
                            <div class="mt-6 pt-6 border-t border-white/30">
                                <div class="text-sm opacity-75" id="cardMeta">HSK 1 Â· é—®å€™</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Card Controls -->
                <div class="flex gap-4 justify-center mb-8">
                    <button onclick="markDifficult()" class="px-8 py-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium shadow-lg transition-all transform hover:scale-105">
                        <i class="fas fa-times mr-2"></i>ä¸è®¤è¯†
                    </button>
                    <button onclick="markKnown()" class="px-8 py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium shadow-lg transition-all transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>è®¤è¯†
                    </button>
                </div>

                <!-- Progress Bar -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>ä»Šæ—¥è¿›åº¦</span>
                        <span><span id="currentProgress">0</span> / <span id="dailyGoal">20</span></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-purple-600 to-pink-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="hidden">
            <div class="max-w-2xl mx-auto">
                
                <!-- Quiz Mode Selector -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                    <div class="text-sm font-medium text-gray-600 mb-3 text-center">é€‰æ‹©æµ‹éªŒæ¨¡å¼</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="setQuizMode('pinyin-to-char')" id="mode-pinyin-to-char" class="mode-badge p-4 rounded-xl border-2 border-purple-200 bg-purple-50 text-purple-700 font-medium transition-all">
                            <i class="fas fa-language mr-2"></i>
                            <div class="text-sm">çœ‹æ‹¼éŸ³é€‰æ±‰å­—</div>
                            <div class="text-xs opacity-75 mt-1">Pinyin â†’ æ±‰å­—</div>
                        </button>
                        <button onclick="setQuizMode('char-to-pinyin')" id="mode-char-to-pinyin" class="mode-badge p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 font-medium transition-all">
                            <i class="fas fa-spell-check mr-2"></i>
                            <div class="text-sm">çœ‹æ±‰å­—é€‰æ‹¼éŸ³</div>
                            <div class="text-xs opacity-75 mt-1">æ±‰å­— â†’ Pinyin</div>
                        </button>
                        <button onclick="setQuizMode('char-to-meaning')" id="mode-char-to-meaning" class="mode-badge p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 font-medium transition-all">
                            <i class="fas fa-globe mr-2"></i>
                            <div class="text-sm">çœ‹æ±‰å­—é€‰å«ä¹‰</div>
                            <div class="text-xs opacity-75 mt-1">æ±‰å­— â†’ å«ä¹‰</div>
                        </button>
                    </div>
                </div>

                <!-- Quiz Card -->
                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <div class="text-center mb-2">
                        <div class="inline-block px-4 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium mb-4" id="quizModeLabel">
                            çœ‹æ‹¼éŸ³é€‰æ±‰å­—
                        </div>
                    </div>
                    
                    <div class="text-center mb-8">
                        <div class="text-6xl mb-4 chinese-text" id="quizQuestion">xuÃ©xÃ­</div>
                        <div class="text-sm text-gray-400" id="quizHint">è¯·é€‰æ‹©æ­£ç¡®çš„æ±‰å­—</div>
                    </div>

                    <!-- Quiz Options -->
                    <div class="grid grid-cols-1 gap-3" id="quizOptions">
                        <!-- Options will be injected by JS -->
                    </div>
                </div>

                <!-- Quiz Stats -->
                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                        <div class="text-2xl font-bold text-green-600" id="quizCorrect">0</div>
                        <div class="text-xs text-gray-500">ç­”å¯¹</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                        <div class="text-2xl font-bold text-red-600" id="quizWrong">0</div>
                        <div class="text-xs text-gray-500">ç­”é”™</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                        <div class="text-2xl font-bold text-blue-600" id="quizAccuracy">0%</div>
                        <div class="text-xs text-gray-500">æ­£ç¡®ç‡</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section id="stats-section" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Learning Progress Chart -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">å­¦ä¹ è¿›åº¦</h3>
                    <div class="h-64">
                        <canvas id="progressChart"></canvas>
                    </div>
                </div>

                <!-- Level Distribution -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800" id="levelChartTitle">ç­‰çº§åˆ†å¸ƒ</h3>
                    <div class="h-64">
                        <canvas id="levelChart"></canvas>
                    </div>
                </div>

                <!-- Quiz Mode Performance -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">æµ‹éªŒæ¨¡å¼è¡¨ç°</h3>
                    <div class="h-64">
                        <canvas id="modeChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">æœ€è¿‘å­¦ä¹ </h3>
                    <div id="recentActivity" class="space-y-3 max-h-64 overflow-y-auto">
                        <!-- Activity items will be injected -->
                    </div>
                </div>
            </div>
        </section>

    </div>

    <script>
        // ==================== VOCABULARY LIBRARIES ====================
        
        const vocabularyLibraries = {
            hsk: {
                id: 'hsk',
                name: 'HSKè¯æ±‡',
                nameEn: 'HSK Vocabulary',
                description: 'å›½é™…æ±‰è¯­æ°´å¹³è€ƒè¯•è¯æ±‡ (HSK 1-4)',
                icon: 'ğŸ“š',
                color: 'purple',
                levelType: 'hsk',
                levelLabel: 'HSKç­‰çº§',
                levels: [
                    { value: 'all', label: 'å…¨éƒ¨' },
                    { value: '1', label: 'HSK 1' },
                    { value: '2', label: 'HSK 2' },
                    { value: '3', label: 'HSK 3' },
                    { value: '4', label: 'HSK 4' }
                ],
                vocabulary: [
                    // HSK 1
                    { id: 1, char: "ä½ å¥½", pinyin: "nÇ hÇo", meaning: "ä½ å¥½ï¼›é—®å€™", english: "Hello", example: "ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ã€‚", exampleEn: "Hello! Nice to meet you.", level: 1, category: "é—®å€™" },
                    { id: 2, char: "è°¢è°¢", pinyin: "xiÃ¨xie", meaning: "è¡¨ç¤ºæ„Ÿè°¢", english: "Thank you", example: "è°¢è°¢ä½ çš„å¸®åŠ©ï¼", exampleEn: "Thank you for your help!", level: 1, category: "ç¤¼è²Œ" },
                    { id: 3, char: "å†è§", pinyin: "zÃ ijiÃ n", meaning: "å‘Šåˆ«ç”¨è¯­", english: "Goodbye", example: "å†è§ï¼æ˜å¤©è§ã€‚", exampleEn: "Goodbye! See you tomorrow.", level: 1, category: "é—®å€™" },
                    { id: 4, char: "æˆ‘", pinyin: "wÇ’", meaning: "è‡ªç§°", english: "I / me", example: "æˆ‘å–œæ¬¢ä¸­æ–‡ã€‚", exampleEn: "I like Chinese.", level: 1, category: "ä»£è¯" },
                    { id: 5, char: "ä½ ", pinyin: "nÇ", meaning: "å¯¹æ–¹", english: "You", example: "ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ", exampleEn: "What's your name?", level: 1, category: "ä»£è¯" },
                    { id: 6, char: "ä»–", pinyin: "tÄ", meaning: "ç¬¬ä¸‰äººç§°ç”·æ€§", english: "He / him", example: "ä»–æ˜¯æˆ‘çš„æœ‹å‹ã€‚", exampleEn: "He is my friend.", level: 1, category: "ä»£è¯" },
                    { id: 7, char: "å¥½", pinyin: "hÇo", meaning: "ä¼˜è‰¯ï¼›æ»¡æ„", english: "Good / well", example: "å¤©æ°”å¾ˆå¥½ã€‚", exampleEn: "The weather is very good.", level: 1, category: "å½¢å®¹è¯" },
                    { id: 8, char: "åƒ", pinyin: "chÄ«", meaning: "è¿›é£Ÿ", english: "To eat", example: "æˆ‘æƒ³åƒé¥­ã€‚", exampleEn: "I want to eat.", level: 1, category: "åŠ¨è¯" },
                    { id: 9, char: "å–", pinyin: "hÄ“", meaning: "é¥®ç”¨", english: "To drink", example: "ä½ å–èŒ¶å—ï¼Ÿ", exampleEn: "Do you drink tea?", level: 1, category: "åŠ¨è¯" },
                    { id: 10, char: "çˆ±", pinyin: "Ã i", meaning: "å–œçˆ±ï¼›çˆ±æŠ¤", english: "To love", example: "æˆ‘çˆ±æˆ‘çš„å®¶äººã€‚", exampleEn: "I love my family.", level: 1, category: "åŠ¨è¯" },
                    
                    // HSK 2
                    { id: 11, char: "å­¦ä¹ ", pinyin: "xuÃ©xÃ­", meaning: "è·å–çŸ¥è¯†", english: "To study / learn", example: "æˆ‘åœ¨å­¦ä¹ ä¸­æ–‡ã€‚", exampleEn: "I am studying Chinese.", level: 2, category: "åŠ¨è¯" },
                    { id: 12, char: "å·¥ä½œ", pinyin: "gÅngzuÃ²", meaning: "åŠ³åŠ¨ï¼›èŒä¸š", english: "To work / job", example: "ä»–åœ¨å…¬å¸å·¥ä½œã€‚", exampleEn: "He works at a company.", level: 2, category: "åŠ¨è¯" },
                    { id: 13, char: "æ—¶é—´", pinyin: "shÃ­jiÄn", meaning: "æ—¶åˆ»", english: "Time", example: "ç°åœ¨å‡ ç‚¹ï¼Ÿ", exampleEn: "What time is it now?", level: 2, category: "åè¯" },
                    { id: 14, char: "æœ‹å‹", pinyin: "pÃ©ngyou", meaning: "å¥½å‹", english: "Friend", example: "å¥¹æ˜¯æˆ‘çš„å¥½æœ‹å‹ã€‚", exampleEn: "She is my good friend.", level: 2, category: "åè¯" },
                    { id: 15, char: "é«˜å…´", pinyin: "gÄoxÃ¬ng", meaning: "æ„‰å¿«", english: "Happy / glad", example: "è§åˆ°ä½ å¾ˆé«˜å…´ã€‚", exampleEn: "I'm glad to meet you.", level: 2, category: "å½¢å®¹è¯" }
                ]
            },
            
            primaryGrade1: {
                id: 'primaryGrade1',
                name: 'äººæ•™ç‰ˆä¸€å¹´çº§ä¸Šå†Œ',
                nameEn: 'Primary Grade 1 Vol.1',
                description: 'å°å­¦è¯­æ–‡ä¸€å¹´çº§ä¸Šå†Œç”Ÿå­—',
                icon: 'ğŸ“–',
                color: 'blue',
                levelType: 'unit',
                levelLabel: 'å•å…ƒ',
                levels: [
                    { value: 'all', label: 'å…¨éƒ¨' },
                    { value: '1', label: 'ç¬¬ä¸€å•å…ƒ' },
                    { value: '2', label: 'ç¬¬äºŒå•å…ƒ' },
                    { value: '3', label: 'ç¬¬ä¸‰å•å…ƒ' },
                    { value: '4', label: 'ç¬¬å››å•å…ƒ' },
                    { value: '5', label: 'ç¬¬äº”å•å…ƒ' }
                ],
                vocabulary: [
                    // ç¬¬ä¸€å•å…ƒ - è¯†å­—
                    { id: 101, char: "å¤©", pinyin: "tiÄn", meaning: "å¤©ç©ºï¼›ä¸€æ˜¼å¤œ", english: "Sky / day", example: "ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚", exampleEn: "The weather is very good today.", level: 1, category: "åè¯", radical: "å¤§" },
                    { id: 102, char: "åœ°", pinyin: "dÃ¬", meaning: "åœ°é¢ï¼›åœŸåœ°", english: "Ground / earth", example: "æˆ‘ååœ¨åœ°ä¸Šã€‚", exampleEn: "I sit on the ground.", level: 1, category: "åè¯", radical: "åœŸ" },
                    { id: 103, char: "äºº", pinyin: "rÃ©n", meaning: "äººç±»", english: "Person / people", example: "ä»–æ˜¯å¥½äººã€‚", exampleEn: "He is a good person.", level: 1, category: "åè¯", radical: "äºº" },
                    { id: 104, char: "ä½ ", pinyin: "nÇ", meaning: "ç§°å¯¹æ–¹", english: "You", example: "ä½ å«ä»€ä¹ˆï¼Ÿ", exampleEn: "What's your name?", level: 1, category: "ä»£è¯", radical: "äº»" },
                    { id: 105, char: "æˆ‘", pinyin: "wÇ’", meaning: "è‡ªç§°", english: "I / me", example: "æˆ‘æ˜¯å­¦ç”Ÿã€‚", exampleEn: "I am a student.", level: 1, category: "ä»£è¯", radical: "æˆˆ" },
                    { id: 106, char: "ä»–", pinyin: "tÄ", meaning: "é‚£ä¸ªäºº", english: "He / him", example: "ä»–å¾ˆé«˜ã€‚", exampleEn: "He is tall.", level: 1, category: "ä»£è¯", radical: "äº»" },
                    { id: 107, char: "ä¸€", pinyin: "yÄ«", meaning: "æ•°å­—1", english: "One", example: "ä¸€ä¸ªäººã€‚", exampleEn: "One person.", level: 1, category: "æ•°è¯", radical: "ä¸€" },
                    { id: 108, char: "äºŒ", pinyin: "Ã¨r", meaning: "æ•°å­—2", english: "Two", example: "äºŒæœˆã€‚", exampleEn: "February.", level: 1, category: "æ•°è¯", radical: "äºŒ" },
                    { id: 109, char: "ä¸‰", pinyin: "sÄn", meaning: "æ•°å­—3", english: "Three", example: "ä¸‰ä¸ªäººã€‚", exampleEn: "Three people.", level: 1, category: "æ•°è¯", radical: "ä¸€" },
                    { id: 110, char: "å››", pinyin: "sÃ¬", meaning: "æ•°å­—4", english: "Four", example: "å››æœˆã€‚", exampleEn: "April.", level: 1, category: "æ•°è¯", radical: "å›—" },
                    
                    // ç¬¬äºŒå•å…ƒ - æ±‰å­—å®¶æ—
                    { id: 201, char: "å£", pinyin: "kÇ’u", meaning: "å˜´", english: "Mouth", example: "å¼ å¼€å£ã€‚", exampleEn: "Open your mouth.", level: 2, category: "åè¯", radical: "å£" },
                    { id: 202, char: "è€³", pinyin: "Ä›r", meaning: "è€³æœµ", english: "Ear", example: "æˆ‘çš„è€³æœµã€‚", exampleEn: "My ear.", level: 2, category: "åè¯", radical: "è€³" },
                    { id: 203, char: "ç›®", pinyin: "mÃ¹", meaning: "çœ¼ç›", english: "Eye", example: "è€³ç›®ã€‚", exampleEn: "Eyes and ears.", level: 2, category: "åè¯", radical: "ç›®" },
                    { id: 204, char: "æ‰‹", pinyin: "shÇ’u", meaning: "æ‰‹æŒ", english: "Hand", example: "æˆ‘çš„æ‰‹ã€‚", exampleEn: "My hand.", level: 2, category: "åè¯", radical: "æ‰‹" },
                    { id: 205, char: "è¶³", pinyin: "zÃº", meaning: "è„š", english: "Foot", example: "æ‰‹è¶³ã€‚", exampleEn: "Hands and feet.", level: 2, category: "åè¯", radical: "è¶³" },
                    { id: 206, char: "ç«™", pinyin: "zhÃ n", meaning: "ç›´ç«‹", english: "To stand", example: "ç«™èµ·æ¥ã€‚", exampleEn: "Stand up.", level: 2, category: "åŠ¨è¯", radical: "ç«‹" },
                    { id: 207, char: "å", pinyin: "zuÃ²", meaning: "å°±åº§", english: "To sit", example: "è¯·åã€‚", exampleEn: "Please sit.", level: 2, category: "åŠ¨è¯", radical: "åœŸ" },
                    { id: 208, char: "æ—¥", pinyin: "rÃ¬", meaning: "å¤ªé˜³ï¼›ç™½å¤©", english: "Sun / day", example: "æ—¥æœˆã€‚", exampleEn: "Sun and moon.", level: 2, category: "åè¯", radical: "æ—¥" },
                    { id: 209, char: "æœˆ", pinyin: "yuÃ¨", meaning: "æœˆäº®ï¼›æœˆä»½", english: "Moon / month", example: "ä¸€æœˆã€‚", exampleEn: "January.", level: 2, category: "åè¯", radical: "æœˆ" },
                    { id: 210, char: "ç«", pinyin: "huÇ’", meaning: "ç‡ƒçƒ§", english: "Fire", example: "ç«è½¦ã€‚", exampleEn: "Train.", level: 2, category: "åè¯", radical: "ç«" },
                    
                    // ç¬¬ä¸‰å•å…ƒ - è¯†å­—ä¸è¯¾æ–‡
                    { id: 301, char: "æ°´", pinyin: "shuÇ", meaning: "æ¶²ä½“", english: "Water", example: "å–æ°´ã€‚", exampleEn: "Drink water.", level: 3, category: "åè¯", radical: "æ°´" },
                    { id: 302, char: "å±±", pinyin: "shÄn", meaning: "é«˜åœ°", english: "Mountain", example: "çˆ¬å±±ã€‚", exampleEn: "Climb a mountain.", level: 3, category: "åè¯", radical: "å±±" },
                    { id: 303, char: "çŸ³", pinyin: "shÃ­", meaning: "å²©çŸ³", english: "Stone / rock", example: "çŸ³å¤´ã€‚", exampleEn: "Stone.", level: 3, category: "åè¯", radical: "çŸ³" },
                    { id: 304, char: "ç”°", pinyin: "tiÃ¡n", meaning: "å†œç”°", english: "Field", example: "æ°´ç”°ã€‚", exampleEn: "Paddy field.", level: 3, category: "åè¯", radical: "ç”°" },
                    { id: 305, char: "ç¦¾", pinyin: "hÃ©", meaning: "è°·ç±»æ¤ç‰©", english: "Grain", example: "ç¦¾è‹—ã€‚", exampleEn: "Rice seedling.", level: 3, category: "åè¯", radical: "ç¦¾" },
                    { id: 306, char: "ä¸Š", pinyin: "shÃ ng", meaning: "ä½ç½®åœ¨é«˜å¤„", english: "Up / on", example: "ä¸Šå­¦ã€‚", exampleEn: "Go to school.", level: 3, category: "æ–¹ä½è¯", radical: "ä¸€" },
                    { id: 307, char: "ä¸‹", pinyin: "xiÃ ", meaning: "ä½ç½®åœ¨ä½å¤„", english: "Down / under", example: "ä¸‹é›¨ã€‚", exampleEn: "It's raining.", level: 3, category: "æ–¹ä½è¯", radical: "ä¸€" },
                    { id: 308, char: "åœŸ", pinyin: "tÇ”", meaning: "æ³¥åœŸ", english: "Soil / earth", example: "åœŸåœ°ã€‚", exampleEn: "Land.", level: 3, category: "åè¯", radical: "åœŸ" },
                    { id: 309, char: "ä¸ª", pinyin: "gÃ¨", meaning: "é‡è¯", english: "Measure word", example: "ä¸€ä¸ªäººã€‚", exampleEn: "One person.", level: 3, category: "é‡è¯", radical: "äºº" },
                    { id: 310, char: "å…«", pinyin: "bÄ", meaning: "æ•°å­—8", english: "Eight", example: "å…«ä¸ªã€‚", exampleEn: "Eight.", level: 3, category: "æ•°è¯", radical: "å…«" },
                    
                    // ç¬¬å››å•å…ƒ - å¸¸ç”¨å­—
                    { id: 401, char: "å…¥", pinyin: "rÃ¹", meaning: "è¿›å»", english: "To enter", example: "å…¥å£ã€‚", exampleEn: "Entrance.", level: 4, category: "åŠ¨è¯", radical: "å…¥" },
                    { id: 402, char: "å¤§", pinyin: "dÃ ", meaning: "é¢ç§¯å¹¿ï¼›å¹´é¾„å¤§", english: "Big / large", example: "å¤§äººã€‚", exampleEn: "Adult.", level: 4, category: "å½¢å®¹è¯", radical: "å¤§" },
                    { id: 403, char: "å°", pinyin: "xiÇo", meaning: "é¢ç§¯å°ï¼›å¹´é¾„å°", english: "Small / little", example: "å°å­©ã€‚", exampleEn: "Child.", level: 4, category: "å½¢å®¹è¯", radical: "å°" },
                    { id: 404, char: "å¤©", pinyin: "tiÄn", meaning: "å¤©ç©º", english: "Sky / heaven", example: "å¤©ä¸Šã€‚", exampleEn: "In the sky.", level: 4, category: "åè¯", radical: "å¤§" },
                    { id: 405, char: "ç«¹", pinyin: "zhÃº", meaning: "ç«¹å­", english: "Bamboo", example: "ç«¹å­ã€‚", exampleEn: "Bamboo.", level: 4, category: "åè¯", radical: "ç«¹" },
                    { id: 406, char: "ç‰™", pinyin: "yÃ¡", meaning: "ç‰™é½¿", english: "Tooth / teeth", example: "åˆ·ç‰™ã€‚", exampleEn: "Brush teeth.", level: 4, category: "åè¯", radical: "ç‰™" },
                    { id: 407, char: "é©¬", pinyin: "mÇ", meaning: "é©¬åŒ¹", english: "Horse", example: "éª‘é©¬ã€‚", exampleEn: "Ride a horse.", level: 4, category: "åè¯", radical: "é©¬" },
                    { id: 408, char: "ç”¨", pinyin: "yÃ²ng", meaning: "ä½¿ç”¨", english: "To use", example: "ç”¨ç¬”ã€‚", exampleEn: "Use a pen.", level: 4, category: "åŠ¨è¯", radical: "ç”¨" },
                    { id: 409, char: "å‡ ", pinyin: "jÇ", meaning: "å¤šå°‘", english: "How many", example: "å‡ ä¸ªï¼Ÿ", exampleEn: "How many?", level: 4, category: "ç–‘é—®è¯", radical: "å‡ " },
                    { id: 410, char: "åª", pinyin: "zhÇ", meaning: "é‡è¯", english: "Measure word", example: "ä¸€åªé¸Ÿã€‚", exampleEn: "A bird.", level: 4, category: "é‡è¯", radical: "å£" },
                    
                    // ç¬¬äº”å•å…ƒ - ç»¼åˆ
                    { id: 501, char: "å„¿", pinyin: "Ã©r", meaning: "å°å­©", english: "Child / son", example: "å„¿å­ã€‚", exampleEn: "Son.", level: 5, category: "åè¯", radical: "å„¿" },
                    { id: 502, char: "è§", pinyin: "jiÃ n", meaning: "çœ‹åˆ°", english: "To see / meet", example: "å†è§ã€‚", exampleEn: "Goodbye.", level: 5, category: "åŠ¨è¯", radical: "è§" },
                    { id: 503, char: "ç™½", pinyin: "bÃ¡i", meaning: "ç™½è‰²", english: "White", example: "ç™½äº‘ã€‚", exampleEn: "White cloud.", level: 5, category: "å½¢å®¹è¯", radical: "ç™½" },
                    { id: 504, char: "ç”°", pinyin: "tiÃ¡n", meaning: "ç”°åœ°", english: "Field", example: "ç”°åœ°ã€‚", exampleEn: "Farmland.", level: 5, category: "åè¯", radical: "ç”°" },
                    { id: 505, char: "ç”µ", pinyin: "diÃ n", meaning: "ç”µåŠ›", english: "Electricity", example: "ç”µè¯ã€‚", exampleEn: "Telephone.", level: 5, category: "åè¯", radical: "ç”°" },
                    { id: 506, char: "ä¹Ÿ", pinyin: "yÄ›", meaning: "åŒæ ·", english: "Also / too", example: "æˆ‘ä¹Ÿå»ã€‚", exampleEn: "I'll go too.", level: 5, category: "å‰¯è¯", radical: "ä¹™" },
                    { id: 507, char: "é•¿", pinyin: "chÃ¡ng", meaning: "é•¿åº¦å¤§", english: "Long", example: "å¾ˆé•¿ã€‚", exampleEn: "Very long.", level: 5, category: "å½¢å®¹è¯", radical: "é•¿" },
                    { id: 508, char: "å±±", pinyin: "shÄn", meaning: "å±±å³°", english: "Mountain", example: "å±±ä¸Šã€‚", exampleEn: "On the mountain.", level: 5, category: "åè¯", radical: "å±±" },
                    { id: 509, char: "å‡º", pinyin: "chÅ«", meaning: "ä»é‡Œåˆ°å¤–", english: "To exit / out", example: "å‡ºå»ã€‚", exampleEn: "Go out.", level: 5, category: "åŠ¨è¯", radical: "å‡µ" },
                    { id: 510, char: "é£", pinyin: "fÄ“i", meaning: "åœ¨ç©ºä¸­ç§»åŠ¨", english: "To fly", example: "é£æœºã€‚", exampleEn: "Airplane.", level: 5, category: "åŠ¨è¯", radical: "é£" }
                ]
            }
        };

        // ==================== STATE MANAGEMENT ====================
        
        let currentLibraryId = localStorage.getItem('currentLibrary_v3') || 'hsk';
        let currentLibrary = vocabularyLibraries[currentLibraryId];
        let currentCardIndex = 0;
        let filteredVocab = [];
        let currentLevelFilter = 'all';
        let todayLearned = [];
        let masteredWords = JSON.parse(localStorage.getItem(`masteredWords_${currentLibraryId}_v3`)) || [];
        let streakData = JSON.parse(localStorage.getItem('streakData_v3')) || { count: 0, lastDate: null };
        let quizStats = { correct: 0, wrong: 0 };
        let quizModeStats = JSON.parse(localStorage.getItem(`quizModeStats_${currentLibraryId}_v3`)) || {
            'pinyin-to-char': { correct: 0, wrong: 0 },
            'char-to-pinyin': { correct: 0, wrong: 0 },
            'char-to-meaning': { correct: 0, wrong: 0 }
        };
        let currentQuizMode = 'pinyin-to-char';
        let dailyGoal = 20;
        let isQuizLocked = false;

        // ==================== INITIALIZATION ====================
        
        function init() {
            renderLibraryModal();
            loadLibrary(currentLibraryId);
            checkDailyReset();
            updateStreakCounter();
            updateStats();
            
            // Show library modal on first visit
            if (!localStorage.getItem('hasVisited_v3')) {
                showLibraryModal();
                localStorage.setItem('hasVisited_v3', 'true');
            }
        }

        // ==================== LIBRARY MANAGEMENT ====================
        
        function renderLibraryModal() {
            const container = document.getElementById('libraryList');
            container.innerHTML = '';
            
            Object.values(vocabularyLibraries).forEach(lib => {
                const card = document.createElement('div');
                card.className = `library-card p-6 rounded-xl border-2 ${lib.id === currentLibraryId ? 'active' : 'border-gray-200 bg-white'}`;
                card.onclick = () => selectLibrary(lib.id);
                
                card.innerHTML = `
                    <div class="text-4xl mb-3">${lib.icon}</div>
                    <h3 class="text-lg font-bold text-gray-800 chinese-text mb-1">${lib.name}</h3>
                    <p class="text-xs text-gray-500 mb-3">${lib.nameEn}</p>
                    <p class="text-sm text-gray-600 mb-4">${lib.description}</p>
                    <div class="flex items-center justify-between">
                        <span class="text-xs text-gray-500">å…± ${lib.vocabulary.length} ä¸ªè¯</span>
                        ${lib.id === currentLibraryId ? '<i class="fas fa-check-circle text-purple-600"></i>' : ''}
                    </div>
                `;
                
                container.appendChild(card);
            });
        }

        function selectLibrary(libraryId) {
            if (libraryId !== currentLibraryId) {
                currentLibraryId = libraryId;
                localStorage.setItem('currentLibrary_v3', libraryId);
                loadLibrary(libraryId);
                renderLibraryModal();
            }
        }

        function loadLibrary(libraryId) {
            currentLibrary = vocabularyLibraries[libraryId];
            
            // Update UI
            document.getElementById('currentLibraryIcon').textContent = currentLibrary.icon;
            document.getElementById('currentLibraryName').textContent = currentLibrary.name;
            document.getElementById('currentLibraryDesc').textContent = currentLibrary.description;
            
            // Load library-specific data
            masteredWords = JSON.parse(localStorage.getItem(`masteredWords_${libraryId}_v3`)) || [];
            quizModeStats = JSON.parse(localStorage.getItem(`quizModeStats_${libraryId}_v3`)) || {
                'pinyin-to-char': { correct: 0, wrong: 0 },
                'char-to-pinyin': { correct: 0, wrong: 0 },
                'char-to-meaning': { correct: 0, wrong: 0 }
            };
            
            // Reset filters and load vocabulary
            currentLevelFilter = 'all';
            filterVocab();
            renderFilterSection();
            updateStats();
            loadCard();
        }

        function renderFilterSection() {
            const container = document.getElementById('filterSection');
            const levels = currentLibrary.levels;
            
            let html = `<div class="flex flex-wrap items-center gap-3">
                <span class="text-sm font-medium text-gray-600">${currentLibrary.levelLabel}ï¼š</span>`;
            
            levels.forEach((level, index) => {
                const isActive = level.value === currentLevelFilter;
                html += `<button onclick="filterByLevel('${level.value}')" 
                    class="level-filter px-4 py-2 rounded-lg text-sm font-medium transition-all ${isActive ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}" 
                    data-level="${level.value}">
                    ${level.label}
                </button>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function filterByLevel(level) {
            currentLevelFilter = level;
            renderFilterSection();
            filterVocab();
            loadCard();
        }

        function filterVocab() {
            if (currentLevelFilter === 'all') {
                filteredVocab = [...currentLibrary.vocabulary];
            } else {
                filteredVocab = currentLibrary.vocabulary.filter(w => w.level == currentLevelFilter);
            }
            currentCardIndex = 0;
        }

        function showLibraryModal() {
            document.getElementById('libraryModal').classList.remove('hidden');
        }

        function closeLibraryModal() {
            document.getElementById('libraryModal').classList.add('hidden');
        }

        // ==================== LEARNING FUNCTIONS ====================
        
        function loadCard() {
            if (filteredVocab.length === 0) {
                alert('æ²¡æœ‰æ›´å¤šè¯æ±‡äº†ï¼è¯·æ›´æ”¹ç­›é€‰æ¡ä»¶ã€‚');
                return;
            }
            
            const word = filteredVocab[currentCardIndex];
            document.getElementById('cardCharacter').textContent = word.char;
            document.getElementById('cardPinyin').textContent = word.pinyin;
            document.getElementById('cardEnglish').textContent = word.meaning || word.english;
            document.getElementById('cardExample').textContent = word.example;
            document.getElementById('cardExampleEn').textContent = word.exampleEn;
            
            // Update meta based on library type
            let meta = '';
            if (currentLibrary.levelType === 'hsk') {
                meta = `HSK ${word.level} Â· ${word.category}`;
            } else if (currentLibrary.levelType === 'unit') {
                meta = `ç¬¬${word.level}å•å…ƒ Â· ${word.category}`;
                if (word.radical) meta += ` Â· éƒ¨é¦–ï¼š${word.radical}`;
            }
            document.getElementById('cardMeta').textContent = meta;
            
            // Reset flip
            document.getElementById('flashCard').classList.remove('flipped');
        }

        function flipCard() {
            document.getElementById('flashCard').classList.toggle('flipped');
        }

        function markKnown() {
            const word = filteredVocab[currentCardIndex];
            
            if (!masteredWords.includes(word.id)) {
                masteredWords.push(word.id);
                localStorage.setItem(`masteredWords_${currentLibraryId}_v3`, JSON.stringify(masteredWords));
                celebrateSuccess();
            }
            
            if (!todayLearned.includes(word.id)) {
                todayLearned.push(word.id);
            }
            
            nextCard();
        }

        function markDifficult() {
            const word = filteredVocab[currentCardIndex];
            
            if (!todayLearned.includes(word.id)) {
                todayLearned.push(word.id);
            }
            
            nextCard();
        }

        function nextCard() {
            currentCardIndex = (currentCardIndex + 1) % filteredVocab.length;
            loadCard();
            updateStats();
            
            if (todayLearned.length === dailyGoal) {
                setTimeout(() => {
                    alert('ğŸ‰ æ­å–œï¼ä»Šå¤©çš„å­¦ä¹ ç›®æ ‡è¾¾æˆäº†ï¼');
                    celebrateSuccess();
                }, 300);
            }
        }

        // ==================== QUIZ FUNCTIONS ====================
        
        function setQuizMode(mode) {
            currentQuizMode = mode;
            
            ['pinyin-to-char', 'char-to-pinyin', 'char-to-meaning'].forEach(m => {
                const btn = document.getElementById('mode-' + m);
                if (m === mode) {
                    if (m === 'pinyin-to-char') {
                        btn.className = 'mode-badge p-4 rounded-xl border-2 border-purple-200 bg-purple-50 text-purple-700 font-medium transition-all';
                    } else if (m === 'char-to-pinyin') {
                        btn.className = 'mode-badge p-4 rounded-xl border-2 border-pink-200 bg-pink-50 text-pink-700 font-medium transition-all';
                    } else {
                        btn.className = 'mode-badge p-4 rounded-xl border-2 border-blue-200 bg-blue-50 text-blue-700 font-medium transition-all';
                    }
                } else {
                    btn.className = 'mode-badge p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 font-medium transition-all';
                }
            });
            
            loadQuiz();
        }

        let currentQuizWord = null;

        function loadQuiz() {
            if (isQuizLocked) return;
            
            const randomIndex = Math.floor(Math.random() * filteredVocab.length);
            currentQuizWord = filteredVocab[randomIndex];
            
            let question, correctAnswer, optionPool;
            
            if (currentQuizMode === 'pinyin-to-char') {
                question = currentQuizWord.pinyin;
                correctAnswer = currentQuizWord.char;
                optionPool = filteredVocab.map(w => w.char);
                document.getElementById('quizModeLabel').textContent = 'çœ‹æ‹¼éŸ³é€‰æ±‰å­—';
                document.getElementById('quizHint').textContent = 'è¯·é€‰æ‹©æ­£ç¡®çš„æ±‰å­—';
            } else if (currentQuizMode === 'char-to-pinyin') {
                question = currentQuizWord.char;
                correctAnswer = currentQuizWord.pinyin;
                optionPool = filteredVocab.map(w => w.pinyin);
                document.getElementById('quizModeLabel').textContent = 'çœ‹æ±‰å­—é€‰æ‹¼éŸ³';
                document.getElementById('quizHint').textContent = 'è¯·é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³';
            } else {
                question = currentQuizWord.char;
                correctAnswer = currentQuizWord.meaning || currentQuizWord.english;
                optionPool = filteredVocab.map(w => w.meaning || w.english);
                document.getElementById('quizModeLabel').textContent = 'çœ‹æ±‰å­—é€‰å«ä¹‰';
                document.getElementById('quizHint').textContent = 'è¯·é€‰æ‹©æ­£ç¡®çš„å«ä¹‰';
            }
            
            document.getElementById('quizQuestion').textContent = question;
            document.getElementById('quizQuestion').className = currentQuizMode === 'pinyin-to-char' ? 'text-6xl mb-4' : 'text-6xl mb-4 chinese-text';
            
            const options = [correctAnswer];
            const otherOptions = optionPool.filter(opt => opt !== correctAnswer);
            
            while (options.length < 4 && otherOptions.length > 0) {
                const randomOpt = otherOptions[Math.floor(Math.random() * otherOptions.length)];
                if (!options.includes(randomOpt)) {
                    options.push(randomOpt);
                    otherOptions.splice(otherOptions.indexOf(randomOpt), 1);
                }
            }
            
            options.sort(() => Math.random() - 0.5);
            
            const container = document.getElementById('quizOptions');
            container.innerHTML = '';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'quiz-option w-full px-6 py-4 bg-gray-50 hover:bg-gray-100 rounded-xl text-left font-medium transition-all';
                if (currentQuizMode !== 'char-to-meaning') {
                    btn.className += ' chinese-text text-lg';
                }
                btn.textContent = option;
                btn.onclick = () => checkQuizAnswer(option, btn, correctAnswer);
                container.appendChild(btn);
            });
        }

        function checkQuizAnswer(selected, button, correctAnswer) {
            if (isQuizLocked) return;
            isQuizLocked = true;
            
            const correct = selected === correctAnswer;
            
            if (correct) {
                button.className = button.className.replace('bg-gray-50', '').replace('hover:bg-gray-100', '') + ' correct-answer';
                quizStats.correct++;
                quizModeStats[currentQuizMode].correct++;
            } else {
                button.className = button.className.replace('bg-gray-50', '').replace('hover:bg-gray-100', '') + ' wrong-answer';
                quizStats.wrong++;
                quizModeStats[currentQuizMode].wrong++;
                
                setTimeout(() => {
                    const buttons = document.querySelectorAll('.quiz-option');
                    buttons.forEach(btn => {
                        if (btn.textContent === correctAnswer) {
                            btn.className = btn.className.replace('bg-gray-50', '').replace('hover:bg-gray-100', '') + ' correct-answer';
                        }
                    });
                }, 500);
            }
            
            localStorage.setItem(`quizModeStats_${currentLibraryId}_v3`, JSON.stringify(quizModeStats));
            updateQuizStats();
            
            setTimeout(() => {
                isQuizLocked = false;
                loadQuiz();
            }, 1500);
        }

        function updateQuizStats() {
            document.getElementById('quizCorrect').textContent = quizStats.correct;
            document.getElementById('quizWrong').textContent = quizStats.wrong;
            
            const total = quizStats.correct + quizStats.wrong;
            const accuracy = total > 0 ? Math.round((quizStats.correct / total) * 100) : 0;
            document.getElementById('quizAccuracy').textContent = accuracy + '%';
        }

        // ==================== UTILITIES ====================
        
        function checkDailyReset() {
            const today = new Date().toDateString();
            const lastDate = localStorage.getItem('lastStudyDate_v3');
            
            if (lastDate !== today) {
                todayLearned = [];
                localStorage.setItem('lastStudyDate_v3', today);
                
                if (lastDate) {
                    const last = new Date(lastDate);
                    const current = new Date(today);
                    const diffDays = Math.floor((current - last) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        streakData.count++;
                    } else if (diffDays > 1) {
                        streakData.count = 0;
                    }
                } else {
                    streakData.count = 1;
                }
                
                streakData.lastDate = today;
                localStorage.setItem('streakData_v3', JSON.stringify(streakData));
            }
        }

        function updateStreakCounter() {
            document.getElementById('streakCount').textContent = streakData.count;
        }

        function updateStats() {
            document.getElementById('todayCount').textContent = todayLearned.length;
            document.getElementById('masteredCount').textContent = masteredWords.length;
            document.getElementById('totalCount').textContent = currentLibrary.vocabulary.length;
            document.getElementById('currentProgress').textContent = todayLearned.length;
            document.getElementById('dailyGoal').textContent = dailyGoal;
            
            const progress = Math.min((todayLearned.length / dailyGoal) * 100, 100);
            document.getElementById('progressBar').style.width = progress + '%';
        }

        function celebrateSuccess() {
            for (let i = 0; i < 30; i++) {
                setTimeout(() => createConfetti(), i * 50);
            }
        }

        function createConfetti() {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa'][Math.floor(Math.random() * 5)];
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 3000);
        }

        function switchTab(tab) {
            document.getElementById('learn-section').classList.add('hidden');
            document.getElementById('quiz-section').classList.add('hidden');
            document.getElementById('stats-section').classList.add('hidden');
            document.getElementById(tab + '-section').classList.remove('hidden');
            
            ['learn', 'quiz', 'stats'].forEach(t => {
                const btn = document.getElementById('tab-' + t);
                if (t === tab) {
                    btn.className = 'flex-1 px-6 py-3 rounded-lg font-medium transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white';
                } else {
                    btn.className = 'flex-1 px-6 py-3 rounded-lg font-medium transition-all text-gray-600 hover:bg-gray-50';
                }
            });
            
            if (tab === 'quiz') {
                loadQuiz();
            } else if (tab === 'stats') {
                renderCharts();
                renderRecentActivity();
            }
        }

        function renderCharts() {
            // Progress chart
            const ctx1 = document.getElementById('progressChart');
            if (ctx1) {
                new Chart(ctx1.getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­', 'å‘¨æ—¥'],
                        datasets: [{
                            label: 'å­¦ä¹ è¯æ±‡æ•°',
                            data: [12, 19, 15, 25, 22, 30, todayLearned.length],
                            borderColor: '#a855f7',
                            backgroundColor: 'rgba(168, 85, 247, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
            
            // Level distribution
            const levelCounts = {};
            currentLibrary.levels.forEach(level => {
                if (level.value !== 'all') levelCounts[level.label] = 0;
            });
            
            masteredWords.forEach(id => {
                const word = currentLibrary.vocabulary.find(w => w.id === id);
                if (word) {
                    const levelLabel = currentLibrary.levels.find(l => l.value == word.level)?.label;
                    if (levelLabel) levelCounts[levelLabel]++;
                }
            });
            
            const ctx2 = document.getElementById('levelChart');
            if (ctx2) {
                new Chart(ctx2.getContext('2d'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(levelCounts),
                        datasets: [{
                            data: Object.values(levelCounts),
                            backgroundColor: ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            }
            
            // Quiz mode performance
            const ctx3 = document.getElementById('modeChart');
            if (ctx3) {
                new Chart(ctx3.getContext('2d'), {
                    type: 'bar',
                    data: {
                        labels: ['æ‹¼éŸ³â†’æ±‰å­—', 'æ±‰å­—â†’æ‹¼éŸ³', 'æ±‰å­—â†’å«ä¹‰'],
                        datasets: [{
                            label: 'ç­”å¯¹é¢˜æ•°',
                            data: [
                                quizModeStats['pinyin-to-char'].correct,
                                quizModeStats['char-to-pinyin'].correct,
                                quizModeStats['char-to-meaning'].correct
                            ],
                            backgroundColor: ['#a855f7', '#ec4899', '#3b82f6'],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }
        }

        function renderRecentActivity() {
            const container = document.getElementById('recentActivity');
            container.innerHTML = '';
            
            const recentWords = masteredWords.slice(-10).reverse();
            
            recentWords.forEach(id => {
                const word = currentLibrary.vocabulary.find(w => w.id === id);
                if (!word) return;
                
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="text-2xl chinese-text">${word.char}</div>
                        <div>
                            <div class="text-sm font-medium">${word.pinyin}</div>
                            <div class="text-xs text-gray-500">${word.meaning || word.english}</div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">${currentLibrary.levels.find(l => l.value == word.level)?.label || ''}</div>
                `;
                container.appendChild(item);
            });
            
            if (recentWords.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-8">è¿˜æ²¡æœ‰å­¦ä¹ è®°å½•</p>';
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
