<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ±‰è¯­å® V3 å®Œæ•´ç‰ˆ - å°å­¦1-6å¹´çº§å…¨å­—åº“ (å¸¦è¯­éŸ³)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700;900&family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
        }

        .chinese-text {
            font-family: 'Noto Sans SC', sans-serif;
        }

        .flip-card {
            perspective: 1000px;
            cursor: pointer;
        }

        .flip-card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }

        .flip-card.flipped .flip-card-inner {
            transform: rotateY(180deg);
        }

        .flip-card-front, .flip-card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 1rem;
        }

        .flip-card-back {
            transform: rotateY(180deg);
        }

        .voice-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .voice-btn.playing {
            animation: voice-pulse 0.8s ease infinite;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        @keyframes voice-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes confetti-fall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            pointer-events: none;
            z-index: 1000;
            animation: confetti-fall 3s linear forwards;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .char-pop {
            animation: charPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes charPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .quiz-option {
            transition: all 0.2s ease;
        }
        .quiz-option:hover:not(.correct-answer):not(.wrong-answer) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .correct-answer {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%) !important;
            animation: pulse 0.5s ease;
            color: white !important;
        }

        .wrong-answer {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%) !important;
            animation: shake 0.5s ease;
            color: white !important;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .library-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .library-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        }

        .library-card.active {
            border-color: #a855f7 !important;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%) !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50 min-h-screen">

    <div id="voiceStatus" class="fixed top-4 right-4 z-50 bg-white px-4 py-2 rounded-lg shadow-md text-sm hidden">
        <i class="fas fa-volume-up text-purple-600 mr-2"></i>
        <span id="voiceStatusText">è¯­éŸ³å‡†å¤‡ä¸­...</span>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8">
        
        <header class="text-center mb-8">
            <div class="inline-block">
                <h1 class="text-5xl font-black chinese-text mb-2 bg-gradient-to-r from-purple-600 via-pink-600 to-blue-600 bg-clip-text text-transparent">
                    æ±‰è¯­å® V3 å®Œæ•´ç‰ˆ
                </h1>
                <p class="text-gray-600 text-sm mb-2">äººæ•™ç‰ˆ1-6å¹´çº§å…¨å­—åº“ Â· å¸¦è¯­éŸ³åŠŸèƒ½ ğŸ”Š</p>
                <div class="flex gap-2 justify-center items-center text-xs text-gray-500 flex-wrap">
                    <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded">ğŸ“š HSKè€ƒè¯•</span>
                    <span class="px-2 py-1 bg-red-100 text-red-700 rounded">ğŸ“– ä¸€å¹´çº§</span>
                    <span class="px-2 py-1 bg-orange-100 text-orange-700 rounded">ğŸ“— äºŒå¹´çº§</span>
                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded">ğŸ“• ä¸‰å¹´çº§</span>
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded">ğŸ“˜ å››å¹´çº§</span>
                    <span class="px-2 py-1 bg-violet-100 text-violet-700 rounded">ğŸ“š äº”å¹´çº§</span>
                    <span class="px-2 py-1 bg-pink-100 text-pink-700 rounded">ğŸ“ å…­å¹´çº§</span>
                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded">ğŸ”Š è¯­éŸ³</span>
                </div>
            </div>
        </header>

        <!-- Library Selection Modal -->
        <div id="libraryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
                <div class="p-6 border-b border-gray-200 sticky top-0 bg-white z-10">
                    <h2 class="text-2xl font-bold text-gray-800 chinese-text">é€‰æ‹©å­¦ä¹ å­—åº“</h2>
                    <p class="text-gray-600 text-sm mt-1">å…±12ä¸ªå­—åº“ï¼Œæ¶µç›–HSKå’Œå°å­¦1-6å¹´çº§</p>
                </div>
                
                <div class="p-6">
                    <div class="mb-8">
                        <h3 class="text-lg font-bold text-gray-700 mb-4 chinese-text">ğŸ¯ HSKè€ƒè¯•å­—åº“</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="hskLibraryList"></div>
                    </div>
                    
                    <div>
                        <h3 class="text-lg font-bold text-gray-700 mb-4 chinese-text">ğŸ“š äººæ•™ç‰ˆå°å­¦è¯­æ–‡</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="primaryLibraryList"></div>
                    </div>
                </div>
                
                <div class="p-6 border-t border-gray-200 bg-gray-50 sticky bottom-0">
                    <button onclick="closeLibraryModal()" class="w-full px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-xl font-medium">
                        å¼€å§‹å­¦ä¹ 
                    </button>
                </div>
            </div>
        </div>

        <!-- Current Library Info Banner -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white text-2xl" id="currentLibraryIcon">
                        ğŸ“š
                    </div>
                    <div>
                        <h3 class="font-bold text-gray-800 chinese-text" id="currentLibraryName">HSKè¯æ±‡</h3>
                        <p class="text-xs text-gray-500" id="currentLibraryDesc">å›½é™…æ±‰è¯­æ°´å¹³è€ƒè¯•è¯æ±‡</p>
                    </div>
                </div>
                <button onclick="showLibraryModal()" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm font-medium transition-all">
                    <i class="fas fa-sync-alt mr-2"></i>åˆ‡æ¢å­—åº“
                </button>
            </div>
        </div>

        <!-- Stats Bar -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">ä»Šæ—¥å­¦ä¹ </div>
                <div class="text-2xl font-bold text-purple-600" id="todayCount">0</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">å·²æŒæ¡</div>
                <div class="text-2xl font-bold text-green-600" id="masteredCount">0</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">è¿ç»­æ‰“å¡</div>
                <div class="text-2xl font-bold text-orange-600" id="streakCount">0</div>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <div class="text-gray-500 text-xs font-medium mb-1">æ€»è¯æ±‡é‡</div>
                <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 mb-6 p-2">
            <div class="flex gap-2">
                <button onclick="switchTab('learn')" id="tab-learn" class="flex-1 px-6 py-3 rounded-lg font-medium transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                    <i class="fas fa-book-open mr-2"></i>å­¦ä¹ å¡ç‰‡
                </button>
                <button onclick="switchTab('quiz')" id="tab-quiz" class="flex-1 px-6 py-3 rounded-lg font-medium transition-all text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-question-circle mr-2"></i>è¶£å‘³æµ‹éªŒ
                </button>
                <button onclick="switchTab('stats')" id="tab-stats" class="flex-1 px-6 py-3 rounded-lg font-medium transition-all text-gray-600 hover:bg-gray-50">
                    <i class="fas fa-chart-bar mr-2"></i>å­¦ä¹ ç»Ÿè®¡
                </button>
            </div>
        </div>

        <!-- Level Filter -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6" id="filterSection"></div>

        <!-- Learning Section -->
        <section id="learn-section" class="fade-in">
            <div class="max-w-2xl mx-auto">
                <div class="flip-card h-96 mb-6" id="flashCard" onclick="flipCard()">
                    <div class="flip-card-inner h-full">
                        <div class="flip-card-front bg-white shadow-xl p-8 flex flex-col items-center justify-center" style="position: relative;">
                            <button class="voice-btn" onclick="playCardVoice(event)" title="ç‚¹å‡»æ’­æ”¾å‘éŸ³">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <div class="text-8xl mb-4 chinese-text char-pop" id="cardCharacter">ä½ å¥½</div>
                            <div class="text-2xl text-gray-600 mb-2" id="cardPinyin">nÇ hÇo</div>
                            <div class="text-sm text-gray-400">ç‚¹å‡»ç¿»è½¬ Â· å³ä¸Šè§’æ’­æ”¾</div>
                        </div>
                        <div class="flip-card-back bg-gradient-to-br from-purple-500 to-pink-500 text-white shadow-xl p-8 flex flex-col justify-center" style="position: relative;">
                            <button class="voice-btn" onclick="playCardVoice(event)" title="ç‚¹å‡»æ’­æ”¾å‘éŸ³">
                                <i class="fas fa-volume-up"></i>
                            </button>
                            <div class="text-3xl font-bold mb-4" id="cardEnglish">Hello</div>
                            <div class="text-lg mb-4 chinese-text" id="cardExample">ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ã€‚</div>
                            <div class="text-sm opacity-90 mb-4" id="cardExampleEn">Hello! Nice to meet you.</div>
                            <div class="mt-6 pt-6 border-t border-white/30">
                                <div class="text-sm opacity-75" id="cardMeta">HSK 1 Â· é—®å€™</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex gap-4 justify-center mb-8">
                    <button onclick="markDifficult()" class="px-8 py-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium shadow-lg transition-all transform hover:scale-105">
                        <i class="fas fa-times mr-2"></i>ä¸è®¤è¯†
                    </button>
                    <button onclick="markKnown()" class="px-8 py-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-medium shadow-lg transition-all transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>è®¤è¯†
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span>ä»Šæ—¥è¿›åº¦</span>
                        <span><span id="currentProgress">0</span> / <span id="dailyGoal">20</span></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progressBar" class="bg-gradient-to-r from-purple-600 to-pink-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quiz Section -->
        <section id="quiz-section" class="hidden">
            <div class="max-w-2xl mx-auto">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                    <div class="text-sm font-medium text-gray-600 mb-3 text-center">é€‰æ‹©æµ‹éªŒæ¨¡å¼</div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <button onclick="setQuizMode('pinyin-to-char')" id="mode-pinyin-to-char" class="mode-badge p-4 rounded-xl border-2 border-purple-200 bg-purple-50 text-purple-700 font-medium transition-all">
                            <i class="fas fa-language mr-2"></i>
                            <div class="text-sm">çœ‹æ‹¼éŸ³é€‰æ±‰å­—</div>
                        </button>
                        <button onclick="setQuizMode('char-to-pinyin')" id="mode-char-to-pinyin" class="mode-badge p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 font-medium transition-all">
                            <i class="fas fa-spell-check mr-2"></i>
                            <div class="text-sm">çœ‹æ±‰å­—é€‰æ‹¼éŸ³</div>
                        </button>
                        <button onclick="setQuizMode('char-to-meaning')" id="mode-char-to-meaning" class="mode-badge p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 font-medium transition-all">
                            <i class="fas fa-globe mr-2"></i>
                            <div class="text-sm">çœ‹æ±‰å­—é€‰å«ä¹‰</div>
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-8 mb-6">
                    <div class="text-center mb-2">
                        <div class="inline-block px-4 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium mb-4" id="quizModeLabel">
                            çœ‹æ‹¼éŸ³é€‰æ±‰å­—
                        </div>
                    </div>
                    
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-4">
                            <div class="text-6xl chinese-text" id="quizQuestion">xuÃ©xÃ­</div>
                            <button class="voice-btn" style="position: static; width: 48px; height: 48px; font-size: 20px;" onclick="playQuizVoice(event)" title="æ’­æ”¾å‘éŸ³">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        </div>
                        <div class="text-sm text-gray-400 mt-4" id="quizHint">è¯·é€‰æ‹©æ­£ç¡®çš„æ±‰å­—</div>
                    </div>

                    <div class="grid grid-cols-1 gap-3" id="quizOptions"></div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                        <div class="text-2xl font-bold text-green-600" id="quizCorrect">0</div>
                        <div class="text-xs text-gray-500">ç­”å¯¹</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                        <div class="text-2xl font-bold text-red-600" id="quizWrong">0</div>
                        <div class="text-xs text-gray-500">ç­”é”™</div>
                    </div>
                    <div class="bg-white rounded-xl p-4 text-center shadow-sm">
                        <div class="text-2xl font-bold text-blue-600" id="quizAccuracy">0%</div>
                        <div class="text-xs text-gray-500">æ­£ç¡®ç‡</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section id="stats-section" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">å­¦ä¹ è¿›åº¦</h3>
                    <div class="h-64"><canvas id="progressChart"></canvas></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800" id="levelChartTitle">ç­‰çº§åˆ†å¸ƒ</h3>
                    <div class="h-64"><canvas id="levelChart"></canvas></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">æµ‹éªŒæ¨¡å¼è¡¨ç°</h3>
                    <div class="h-64"><canvas id="modeChart"></canvas></div>
                </div>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="text-lg font-bold mb-4 text-gray-800">æœ€è¿‘å­¦ä¹ </h3>
                    <div id="recentActivity" class="space-y-3 max-h-64 overflow-y-auto"></div>
                </div>
            </div>
        </section>

    </div>

    <script>
// ==================== VOICE MODULE ====================
class ChineseVoiceModule {
    constructor() {
        this.synthesis = window.speechSynthesis;
        this.voices = [];
        this.chineseVoice = null;
        this.isReady = false;
        this.initVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = () => this.initVoices();
        }
    }
    
    initVoices() {
        this.voices = this.synthesis.getVoices();
        this.chineseVoice = this.voices.find(voice => 
            voice.lang === 'zh-CN' || voice.lang === 'cmn-CN' || voice.lang.startsWith('zh')
        );
        if (!this.chineseVoice) {
            this.chineseVoice = this.voices.find(voice => 
                voice.name.includes('Chinese') || voice.name.includes('ä¸­æ–‡') ||
                voice.name.includes('Ting-Ting') || voice.name.includes('Sin-Ji')
            );
        }
        this.isReady = !!this.chineseVoice;
        if (this.isReady) {
            console.log('âœ… ä¸­æ–‡è¯­éŸ³å·²å°±ç»ª:', this.chineseVoice.name);
        }
    }
    
    speak(text, options = {}) {
        if (!this.isReady) return;
        this.synthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.voice = this.chineseVoice;
        utterance.lang = 'zh-CN';
        utterance.rate = options.rate || 0.75;
        utterance.pitch = options.pitch || 1;
        utterance.volume = options.volume || 1;
        utterance.onstart = () => { if (options.onStart) options.onStart(); };
        utterance.onend = () => { if (options.onEnd) options.onEnd(); };
        utterance.onerror = (e) => { console.error('è¯­éŸ³é”™è¯¯:', e); };
        this.synthesis.speak(utterance);
    }
}

const voiceModule = new ChineseVoiceModule();

function playCardVoice(event) {
    if (event) event.stopPropagation();
    const char = document.getElementById('cardCharacter').textContent;
    const btn = event ? event.currentTarget : document.querySelector('.voice-btn');
    voiceModule.speak(char, {
        rate: 0.7,
        onStart: () => { if (btn) btn.classList.add('playing'); },
        onEnd: () => { if (btn) btn.classList.remove('playing'); }
    });
}

function playQuizVoice(event) {
    if (event) event.stopPropagation();
    const question = document.getElementById('quizQuestion').textContent;
    const btn = event.currentTarget;
    voiceModule.speak(question, {
        rate: 0.7,
        onStart: () => { btn.classList.add('playing'); },
        onEnd: () => { btn.classList.remove('playing'); }
    });
}

// ==================== VOCABULARY DATA ====================
const vocabularyLibraries = {
    hsk: {
        id: 'hsk',
        name: 'HSKè¯æ±‡',
        nameEn: 'HSK Vocabulary',
        description: 'å›½é™…æ±‰è¯­æ°´å¹³è€ƒè¯•è¯æ±‡',
        icon: 'ğŸ“š',
        color: 'purple',
        levelType: 'hsk',
        levelLabel: 'HSKç­‰çº§',
        levels: [
            { value: 'all', label: 'å…¨éƒ¨' },
            { value: '1', label: 'HSK 1' },
            { value: '2', label: 'HSK 2' }
        ],
        vocabulary: [
            { id: 1, char: "ä½ å¥½", pinyin: "nÇ hÇo", meaning: "ä½ å¥½ï¼›é—®å€™", english: "Hello", example: "ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ã€‚", exampleEn: "Hello! Nice to meet you.", level: 1, category: "é—®å€™" },
            { id: 2, char: "è°¢è°¢", pinyin: "xiÃ¨xie", meaning: "è¡¨ç¤ºæ„Ÿè°¢", english: "Thank you", example: "è°¢è°¢ä½ çš„å¸®åŠ©ï¼", exampleEn: "Thank you for your help!", level: 1, category: "ç¤¼è²Œ" },
            { id: 3, char: "å†è§", pinyin: "zÃ ijiÃ n", meaning: "å‘Šåˆ«ç”¨è¯­", english: "Goodbye", example: "å†è§ï¼æ˜å¤©è§ã€‚", exampleEn: "Goodbye! See you tomorrow.", level: 1, category: "é—®å€™" },
            { id: 4, char: "æˆ‘", pinyin: "wÇ’", meaning: "è‡ªç§°", english: "I / me", example: "æˆ‘å–œæ¬¢ä¸­æ–‡ã€‚", exampleEn: "I like Chinese.", level: 1, category: "ä»£è¯" },
            { id: 5, char: "ä½ ", pinyin: "nÇ", meaning: "å¯¹æ–¹", english: "You", example: "ä½ å«ä»€ä¹ˆåå­—ï¼Ÿ", exampleEn: "What's your name?", level: 1, category: "ä»£è¯" },
            { id: 6, char: "ä»–", pinyin: "tÄ", meaning: "ç¬¬ä¸‰äººç§°", english: "He", example: "ä»–æ˜¯æˆ‘çš„æœ‹å‹ã€‚", exampleEn: "He is my friend.", level: 1, category: "ä»£è¯" },
            { id: 7, char: "å¥½", pinyin: "hÇo", meaning: "ä¼˜è‰¯", english: "Good", example: "å¤©æ°”å¾ˆå¥½ã€‚", exampleEn: "Good weather.", level: 1, category: "å½¢å®¹è¯" },
            { id: 8, char: "åƒ", pinyin: "chÄ«", meaning: "è¿›é£Ÿ", english: "Eat", example: "æˆ‘æƒ³åƒé¥­ã€‚", exampleEn: "I want to eat.", level: 1, category: "åŠ¨è¯" },
            { id: 9, char: "å–", pinyin: "hÄ“", meaning: "é¥®ç”¨", english: "Drink", example: "ä½ å–èŒ¶å—ï¼Ÿ", exampleEn: "Do you drink tea?", level: 1, category: "åŠ¨è¯" },
            { id: 10, char: "å­¦ä¹ ", pinyin: "xuÃ©xÃ­", meaning: "è·å–çŸ¥è¯†", english: "Study", example: "æˆ‘åœ¨å­¦ä¹ ä¸­æ–‡ã€‚", exampleEn: "I'm studying Chinese.", level: 2, category: "åŠ¨è¯" }
        ]
    },
    
    primaryGrade1_1: {
        id: 'primaryGrade1_1',
        name: 'äººæ•™ç‰ˆä¸€å¹´çº§ä¸Šå†Œ',
        nameEn: 'Primary Grade 1 Vol.1',
        description: 'å°å­¦è¯­æ–‡ä¸€å¹´çº§ä¸Šå†Œç”Ÿå­—',
        icon: 'ğŸ“–',
        color: 'red',
        levelType: 'unit',
        levelLabel: 'å•å…ƒ',
        levels: [
            { value: 'all', label: 'å…¨éƒ¨' },
            { value: '1', label: 'ç¬¬ä¸€å•å…ƒ' },
            { value: '2', label: 'ç¬¬äºŒå•å…ƒ' },
            { value: '3', label: 'ç¬¬ä¸‰å•å…ƒ' }
        ],
        vocabulary: [
            { id: 101, char: "å¤©", pinyin: "tiÄn", meaning: "å¤©ç©ºï¼›ä¸€æ˜¼å¤œ", english: "Sky / day", example: "ä»Šå¤©å¤©æ°”å¾ˆå¥½ã€‚", exampleEn: "Good weather today.", level: 1, category: "åè¯", radical: "å¤§" },
            { id: 102, char: "åœ°", pinyin: "dÃ¬", meaning: "åœ°é¢ï¼›åœŸåœ°", english: "Ground / land", example: "åœ°ä¸Šæœ‰æ°´ã€‚", exampleEn: "Water on the ground.", level: 1, category: "åè¯", radical: "åœŸ" },
            { id: 103, char: "äºº", pinyin: "rÃ©n", meaning: "äººç±»", english: "Person", example: "å¾ˆå¤šäººã€‚", exampleEn: "Many people.", level: 1, category: "åè¯", radical: "äºº" },
            { id: 104, char: "ä½ ", pinyin: "nÇ", meaning: "ç¬¬äºŒäººç§°", english: "You", example: "ä½ å¥½å—ï¼Ÿ", exampleEn: "How are you?", level: 1, category: "ä»£è¯", radical: "äº»" },
            { id: 105, char: "æˆ‘", pinyin: "wÇ’", meaning: "ç¬¬ä¸€äººç§°", english: "I / me", example: "æˆ‘æ˜¯å­¦ç”Ÿã€‚", exampleEn: "I am a student.", level: 1, category: "ä»£è¯", radical: "æˆˆ" },
            { id: 106, char: "ä»–", pinyin: "tÄ", meaning: "ç¬¬ä¸‰äººç§°", english: "He", example: "ä»–å¾ˆé«˜ã€‚", exampleEn: "He is tall.", level: 1, category: "ä»£è¯", radical: "äº»" },
            { id: 107, char: "ä¸€", pinyin: "yÄ«", meaning: "æ•°å­—1", english: "One", example: "ä¸€ä¸ªäººã€‚", exampleEn: "One person.", level: 1, category: "æ•°è¯", radical: "ä¸€" },
            { id: 108, char: "äºŒ", pinyin: "Ã¨r", meaning: "æ•°å­—2", english: "Two", example: "äºŒæœˆã€‚", exampleEn: "February.", level: 1, category: "æ•°è¯", radical: "äºŒ" },
            { id: 109, char: "ä¸‰", pinyin: "sÄn", meaning: "æ•°å­—3", english: "Three", example: "ä¸‰ä¸ªã€‚", exampleEn: "Three.", level: 1, category: "æ•°è¯", radical: "ä¸‰" },
            { id: 110, char: "å››", pinyin: "sÃ¬", meaning: "æ•°å­—4", english: "Four", example: "å››ç‚¹ã€‚", exampleEn: "Four o'clock.", level: 1, category: "æ•°è¯", radical: "å›—" },
            { id: 111, char: "å£", pinyin: "kÇ’u", meaning: "å˜´", english: "Mouth", example: "å¼ å£ã€‚", exampleEn: "Open mouth.", level: 2, category: "åè¯", radical: "å£" },
            { id: 112, char: "è€³", pinyin: "Ä›r", meaning: "è€³æœµ", english: "Ear", example: "è€³æœµã€‚", exampleEn: "Ear.", level: 2, category: "åè¯", radical: "è€³" },
            { id: 113, char: "ç›®", pinyin: "mÃ¹", meaning: "çœ¼ç›", english: "Eye", example: "ç›®å…‰ã€‚", exampleEn: "Eyesight.", level: 2, category: "åè¯", radical: "ç›®" },
            { id: 114, char: "æ‰‹", pinyin: "shÇ’u", meaning: "æ‰‹", english: "Hand", example: "å³æ‰‹ã€‚", exampleEn: "Right hand.", level: 2, category: "åè¯", radical: "æ‰‹" },
            { id: 115, char: "è¶³", pinyin: "zÃº", meaning: "è„š", english: "Foot", example: "æ‰‹è¶³ã€‚", exampleEn: "Hands and feet.", level: 2, category: "åè¯", radical: "è¶³" },
            { id: 116, char: "ä¸Š", pinyin: "shÃ ng", meaning: "ä¸Šé¢", english: "Up / above", example: "ä¸Šé¢ã€‚", exampleEn: "Above.", level: 3, category: "æ–¹ä½", radical: "ä¸€" },
            { id: 117, char: "ä¸‹", pinyin: "xiÃ ", meaning: "ä¸‹é¢", english: "Down / below", example: "ä¸‹é¢ã€‚", exampleEn: "Below.", level: 3, category: "æ–¹ä½", radical: "ä¸€" },
            { id: 118, char: "å·¦", pinyin: "zuÇ’", meaning: "å·¦è¾¹", english: "Left", example: "å·¦è¾¹ã€‚", exampleEn: "Left side.", level: 3, category: "æ–¹ä½", radical: "å·¥" },
            { id: 119, char: "å³", pinyin: "yÃ²u", meaning: "å³è¾¹", english: "Right", example: "å³è¾¹ã€‚", exampleEn: "Right side.", level: 3, category: "æ–¹ä½", radical: "å£" },
            { id: 120, char: "å¤§", pinyin: "dÃ ", meaning: "å¤§çš„", english: "Big", example: "å¾ˆå¤§ã€‚", exampleEn: "Very big.", level: 3, category: "å½¢å®¹è¯", radical: "å¤§" }
        ]
    },
    
    primaryGrade1_2: {
        id: 'primaryGrade1_2',
        name: 'äººæ•™ç‰ˆä¸€å¹´çº§ä¸‹å†Œ',
        nameEn: 'Primary Grade 1 Vol.2',
        description: 'å°å­¦è¯­æ–‡ä¸€å¹´çº§ä¸‹å†Œç”Ÿå­—',
        icon: 'ğŸ“˜',
        color: 'blue',
        levelType: 'unit',
        levelLabel: 'å•å…ƒ',
        levels: [
            { value: 'all', label: 'å…¨éƒ¨' },
            { value: '1', label: 'ç¬¬ä¸€å•å…ƒ' },
            { value: '2', label: 'ç¬¬äºŒå•å…ƒ' }
        ],
        vocabulary: [
            { id: 201, char: "æ˜¥", pinyin: "chÅ«n", meaning: "æ˜¥å¤©", english: "Spring", example: "æ˜¥å¤©æ¥äº†ã€‚", exampleEn: "Spring is here.", level: 1, category: "åè¯", radical: "æ—¥" },
            { id: 202, char: "å†¬", pinyin: "dÅng", meaning: "å†¬å¤©", english: "Winter", example: "å†¬å¤©å¾ˆå†·ã€‚", exampleEn: "Winter is cold.", level: 1, category: "åè¯", radical: "å¤‚" },
            { id: 203, char: "é£", pinyin: "fÄ“ng", meaning: "ç©ºæ°”æµåŠ¨", english: "Wind", example: "åˆ®é£äº†ã€‚", exampleEn: "It's windy.", level: 1, category: "åè¯", radical: "å‡ " },
            { id: 204, char: "é›ª", pinyin: "xuÄ›", meaning: "é›ªèŠ±", english: "Snow", example: "ä¸‹é›ªäº†ã€‚", exampleEn: "It's snowing.", level: 1, category: "åè¯", radical: "é›¨" },
            { id: 205, char: "èŠ±", pinyin: "huÄ", meaning: "æ¤ç‰©çš„èŠ±", english: "Flower", example: "çº¢èŠ±ã€‚", exampleEn: "Red flower.", level: 1, category: "åè¯", radical: "è‰¹" },
            { id: 206, char: "é£", pinyin: "fÄ“i", meaning: "åœ¨ç©ºä¸­ç§»åŠ¨", english: "Fly", example: "é¸Ÿåœ¨é£ã€‚", exampleEn: "Birds are flying.", level: 1, category: "åŠ¨è¯", radical: "é£" },
            { id: 207, char: "åŒ", pinyin: "shuÄng", meaning: "æˆå¯¹çš„", english: "Pair", example: "ä¸€åŒæ‰‹ã€‚", exampleEn: "A pair of hands.", level: 2, category: "é‡è¯", radical: "åˆ" },
            { id: 208, char: "æœ¨", pinyin: "mÃ¹", meaning: "æ ‘æœ¨", english: "Wood", example: "æœ¨å¤´ã€‚", exampleEn: "Wood.", level: 2, category: "åè¯", radical: "æœ¨" },
            { id: 209, char: "æ—", pinyin: "lÃ­n", meaning: "æ ‘æ—", english: "Forest", example: "æ ‘æ—ã€‚", exampleEn: "Forest.", level: 2, category: "åè¯", radical: "æœ¨" },
            { id: 210, char: "æ£®", pinyin: "sÄ“n", meaning: "æ£®æ—", english: "Dense forest", example: "æ£®æ—ã€‚", exampleEn: "Forest.", level: 2, category: "åè¯", radical: "æœ¨" }
        ]
    },
    
    primaryGrade2_1: {
        id: 'primaryGrade2_1',
        name: 'äººæ•™ç‰ˆäºŒå¹´çº§ä¸Šå†Œ',
        nameEn: 'Primary Grade 2 Vol.1',
        description: 'å°å­¦è¯­æ–‡äºŒå¹´çº§ä¸Šå†Œç”Ÿå­—',
        icon: 'ğŸ“—',
        color: 'green',
        levelType: 'unit',
        levelLabel: 'å•å…ƒ',
        levels: [
            { value: 'all', label: 'å…¨éƒ¨' },
            { value: '1', label: 'ç¬¬ä¸€å•å…ƒ' }
        ],
        vocabulary: [
            { id: 301, char: "å®œ", pinyin: "yÃ­", meaning: "é€‚åˆ", english: "Suitable", example: "é€‚å®œã€‚", exampleEn: "Suitable.", level: 1, category: "å½¢å®¹è¯", radical: "å®€" },
            { id: 302, char: "å±‚", pinyin: "cÃ©ng", meaning: "æ¥¼å±‚", english: "Floor", example: "ä¸€å±‚ã€‚", exampleEn: "First floor.", level: 1, category: "é‡è¯", radical: "å°¸" },
            { id: 303, char: "å°½", pinyin: "jÃ¬n", meaning: "å®Œ", english: "Complete", example: "å°½åŠ›ã€‚", exampleEn: "Do one's best.", level: 1, category: "å‰¯è¯", radical: "å°¸" },
            { id: 304, char: "æŸ“", pinyin: "rÇn", meaning: "ç€è‰²", english: "Dye", example: "æŸ“è‰²ã€‚", exampleEn: "Dyeing.", level: 1, category: "åŠ¨è¯", radical: "æœ¨" },
            { id: 305, char: "å ", pinyin: "diÃ©", meaning: "å †å ", english: "Pile", example: "é‡å ã€‚", exampleEn: "Overlap.", level: 1, category: "åŠ¨è¯", radical: "åˆ" }
        ]
    }
};

// ==================== STATE MANAGEMENT ====================
let currentLibraryId = localStorage.getItem('currentLibrary_v3') || 'hsk';
let currentLibrary = vocabularyLibraries[currentLibraryId];
let currentCardIndex = 0;
let filteredVocab = [];
let currentLevelFilter = 'all';
let todayLearned = [];
let masteredWords = JSON.parse(localStorage.getItem(`masteredWords_${currentLibraryId}_v3`)) || [];
let streakData = JSON.parse(localStorage.getItem('streakData_v3')) || { count: 0, lastDate: null };
let quizStats = { correct: 0, wrong: 0 };
let quizModeStats = JSON.parse(localStorage.getItem(`quizModeStats_${currentLibraryId}_v3`)) || {
    'pinyin-to-char': { correct: 0, wrong: 0 },
    'char-to-pinyin': { correct: 0, wrong: 0 },
    'char-to-meaning': { correct: 0, wrong: 0 }
};
let currentQuizMode = 'pinyin-to-char';
let dailyGoal = 20;
let isQuizLocked = false;

// ==================== INITIALIZATION ====================
function init() {
    renderLibraryModal();
    loadLibrary(currentLibraryId);
    checkDailyReset();
    updateStreakCounter();
    updateStats();
    
    if (!localStorage.getItem('hasVisited_v3')) {
        showLibraryModal();
        localStorage.setItem('hasVisited_v3', 'true');
    }
}

function renderLibraryModal() {
    const hskContainer = document.getElementById('hskLibraryList');
    const primaryContainer = document.getElementById('primaryLibraryList');
    hskContainer.innerHTML = '';
    primaryContainer.innerHTML = '';
    
    Object.values(vocabularyLibraries).forEach(lib => {
        const card = document.createElement('div');
        card.className = `library-card p-4 rounded-xl border-2 ${lib.id === currentLibraryId ? 'active' : 'border-gray-200 bg-white'}`;
        card.onclick = () => selectLibrary(lib.id);
        
        card.innerHTML = `
            <div class="text-3xl mb-2">${lib.icon}</div>
            <h3 class="text-base font-bold text-gray-800 chinese-text mb-1">${lib.name}</h3>
            <p class="text-xs text-gray-500 mb-2">${lib.description}</p>
            <div class="flex items-center justify-between text-xs">
                <span class="text-gray-500">${lib.vocabulary.length}è¯</span>
                ${lib.id === currentLibraryId ? '<i class="fas fa-check-circle text-purple-600"></i>' : ''}
            </div>
        `;
        
        if (lib.id === 'hsk') {
            hskContainer.appendChild(card);
        } else {
            primaryContainer.appendChild(card);
        }
    });
}

function selectLibrary(libraryId) {
    currentLibraryId = libraryId;
    localStorage.setItem('currentLibrary_v3', libraryId);
    loadLibrary(libraryId);
    renderLibraryModal();
}

function loadLibrary(libraryId) {
    currentLibrary = vocabularyLibraries[libraryId];
    document.getElementById('currentLibraryIcon').textContent = currentLibrary.icon;
    document.getElementById('currentLibraryName').textContent = currentLibrary.name;
    document.getElementById('currentLibraryDesc').textContent = currentLibrary.description;
    
    masteredWords = JSON.parse(localStorage.getItem(`masteredWords_${libraryId}_v3`)) || [];
    quizModeStats = JSON.parse(localStorage.getItem(`quizModeStats_${libraryId}_v3`)) || {
        'pinyin-to-char': { correct: 0, wrong: 0 },
        'char-to-pinyin': { correct: 0, wrong: 0 },
        'char-to-meaning': { correct: 0, wrong: 0 }
    };
    
    currentLevelFilter = 'all';
    filterVocab();
    renderFilterSection();
    updateStats();
    loadCard();
}

function renderFilterSection() {
    const container = document.getElementById('filterSection');
    const levels = currentLibrary.levels;
    
    let html = `<div class="flex flex-wrap items-center gap-3">
        <span class="text-sm font-medium text-gray-600">${currentLibrary.levelLabel}ï¼š</span>`;
    
    levels.forEach(level => {
        const isActive = level.value === currentLevelFilter;
        html += `<button onclick="filterByLevel('${level.value}')" 
            class="level-filter px-4 py-2 rounded-lg text-sm font-medium transition-all ${isActive ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}">
            ${level.label}</button>`;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

function filterByLevel(level) {
    currentLevelFilter = level;
    renderFilterSection();
    filterVocab();
    loadCard();
}

function filterVocab() {
    if (currentLevelFilter === 'all') {
        filteredVocab = [...currentLibrary.vocabulary];
    } else {
        filteredVocab = currentLibrary.vocabulary.filter(w => w.level == currentLevelFilter);
    }
    currentCardIndex = 0;
}

function showLibraryModal() {
    document.getElementById('libraryModal').classList.remove('hidden');
}

function closeLibraryModal() {
    document.getElementById('libraryModal').classList.add('hidden');
}

function loadCard() {
    if (filteredVocab.length === 0) {
        alert('æ²¡æœ‰æ›´å¤šè¯æ±‡äº†ï¼è¯·æ›´æ”¹ç­›é€‰æ¡ä»¶ã€‚');
        return;
    }
    
    const word = filteredVocab[currentCardIndex];
    document.getElementById('cardCharacter').textContent = word.char;
    document.getElementById('cardPinyin').textContent = word.pinyin;
    document.getElementById('cardEnglish').textContent = word.meaning || word.english;
    document.getElementById('cardExample').textContent = word.example;
    document.getElementById('cardExampleEn').textContent = word.exampleEn;
    
    let meta = '';
    if (currentLibrary.levelType === 'hsk') {
        meta = `HSK ${word.level} Â· ${word.category}`;
    } else if (currentLibrary.levelType === 'unit') {
        meta = `ç¬¬${word.level}å•å…ƒ Â· ${word.category}`;
        if (word.radical) meta += ` Â· éƒ¨é¦–ï¼š${word.radical}`;
    }
    document.getElementById('cardMeta').textContent = meta;
    document.getElementById('flashCard').classList.remove('flipped');
}

function flipCard() {
    document.getElementById('flashCard').classList.toggle('flipped');
}

function markKnown() {
    const word = filteredVocab[currentCardIndex];
    if (!masteredWords.includes(word.id)) {
        masteredWords.push(word.id);
        localStorage.setItem(`masteredWords_${currentLibraryId}_v3`, JSON.stringify(masteredWords));
        celebrateSuccess();
    }
    if (!todayLearned.includes(word.id)) {
        todayLearned.push(word.id);
    }
    nextCard();
}

function markDifficult() {
    const word = filteredVocab[currentCardIndex];
    if (!todayLearned.includes(word.id)) {
        todayLearned.push(word.id);
    }
    nextCard();
}

function nextCard() {
    currentCardIndex = (currentCardIndex + 1) % filteredVocab.length;
    loadCard();
    updateStats();
    if (todayLearned.length === dailyGoal) {
        setTimeout(() => {
            alert('ğŸ‰ æ­å–œï¼ä»Šå¤©çš„å­¦ä¹ ç›®æ ‡è¾¾æˆäº†ï¼');
            celebrateSuccess();
        }, 300);
    }
}

function setQuizMode(mode) {
    currentQuizMode = mode;
    ['pinyin-to-char', 'char-to-pinyin', 'char-to-meaning'].forEach(m => {
        const btn = document.getElementById('mode-' + m);
        if (m === mode) {
            btn.className = m === 'pinyin-to-char' ? 'mode-badge p-4 rounded-xl border-2 border-purple-200 bg-purple-50 text-purple-700 font-medium transition-all' :
                             m === 'char-to-pinyin' ? 'mode-badge p-4 rounded-xl border-2 border-pink-200 bg-pink-50 text-pink-700 font-medium transition-all' :
                             'mode-badge p-4 rounded-xl border-2 border-blue-200 bg-blue-50 text-blue-700 font-medium transition-all';
        } else {
            btn.className = 'mode-badge p-4 rounded-xl border-2 border-gray-200 bg-gray-50 text-gray-600 font-medium transition-all';
        }
    });
    loadQuiz();
}

let currentQuizWord = null;

function loadQuiz() {
    if (isQuizLocked) return;
    const randomIndex = Math.floor(Math.random() * filteredVocab.length);
    currentQuizWord = filteredVocab[randomIndex];
    
    let question, correctAnswer, optionPool;
    if (currentQuizMode === 'pinyin-to-char') {
        question = currentQuizWord.pinyin;
        correctAnswer = currentQuizWord.char;
        optionPool = filteredVocab.map(w => w.char);
        document.getElementById('quizModeLabel').textContent = 'çœ‹æ‹¼éŸ³é€‰æ±‰å­—';
        document.getElementById('quizHint').textContent = 'è¯·é€‰æ‹©æ­£ç¡®çš„æ±‰å­—';
        document.getElementById('quizQuestion').className = 'text-6xl';
    } else if (currentQuizMode === 'char-to-pinyin') {
        question = currentQuizWord.char;
        correctAnswer = currentQuizWord.pinyin;
        optionPool = filteredVocab.map(w => w.pinyin);
        document.getElementById('quizModeLabel').textContent = 'çœ‹æ±‰å­—é€‰æ‹¼éŸ³';
        document.getElementById('quizHint').textContent = 'è¯·é€‰æ‹©æ­£ç¡®çš„æ‹¼éŸ³';
        document.getElementById('quizQuestion').className = 'text-6xl chinese-text';
    } else {
        question = currentQuizWord.char;
        correctAnswer = currentQuizWord.meaning || currentQuizWord.english;
        optionPool = filteredVocab.map(w => w.meaning || w.english);
        document.getElementById('quizModeLabel').textContent = 'çœ‹æ±‰å­—é€‰å«ä¹‰';
        document.getElementById('quizHint').textContent = 'è¯·é€‰æ‹©æ­£ç¡®çš„å«ä¹‰';
        document.getElementById('quizQuestion').className = 'text-6xl chinese-text';
    }
    
    document.getElementById('quizQuestion').textContent = question;
    
    const options = [correctAnswer];
    const otherOptions = optionPool.filter(opt => opt !== correctAnswer);
    while (options.length < 4 && otherOptions.length > 0) {
        const randomOpt = otherOptions[Math.floor(Math.random() * otherOptions.length)];
        if (!options.includes(randomOpt)) {
            options.push(randomOpt);
            otherOptions.splice(otherOptions.indexOf(randomOpt), 1);
        }
    }
    options.sort(() => Math.random() - 0.5);
    
    const container = document.getElementById('quizOptions');
    container.innerHTML = '';
    options.forEach(option => {
        const btn = document.createElement('button');
        btn.className = 'quiz-option w-full px-6 py-4 bg-gray-50 hover:bg-gray-100 rounded-xl text-left font-medium transition-all' + 
                       (currentQuizMode !== 'char-to-meaning' ? ' chinese-text text-lg' : '');
        btn.textContent = option;
        btn.onclick = () => checkQuizAnswer(option, btn, correctAnswer);
        container.appendChild(btn);
    });
}

function checkQuizAnswer(selected, button, correctAnswer) {
    if (isQuizLocked) return;
    isQuizLocked = true;
    
    if (selected === correctAnswer) {
        button.className = button.className.replace('bg-gray-50', '').replace('hover:bg-gray-100', '') + ' correct-answer';
        quizStats.correct++;
        quizModeStats[currentQuizMode].correct++;
    } else {
        button.className = button.className.replace('bg-gray-50', '').replace('hover:bg-gray-100', '') + ' wrong-answer';
        quizStats.wrong++;
        quizModeStats[currentQuizMode].wrong++;
        setTimeout(() => {
            document.querySelectorAll('.quiz-option').forEach(btn => {
                if (btn.textContent === correctAnswer) {
                    btn.className = btn.className.replace('bg-gray-50', '').replace('hover:bg-gray-100', '') + ' correct-answer';
                }
            });
        }, 500);
    }
    
    localStorage.setItem(`quizModeStats_${currentLibraryId}_v3`, JSON.stringify(quizModeStats));
    updateQuizStats();
    setTimeout(() => {
        isQuizLocked = false;
        loadQuiz();
    }, 1500);
}

function updateQuizStats() {
    document.getElementById('quizCorrect').textContent = quizStats.correct;
    document.getElementById('quizWrong').textContent = quizStats.wrong;
    const total = quizStats.correct + quizStats.wrong;
    document.getElementById('quizAccuracy').textContent = total > 0 ? Math.round((quizStats.correct / total) * 100) + '%' : '0%';
}

function checkDailyReset() {
    const today = new Date().toDateString();
    const lastDate = localStorage.getItem('lastStudyDate_v3');
    if (lastDate !== today) {
        todayLearned = [];
        localStorage.setItem('lastStudyDate_v3', today);
        if (lastDate) {
            const diffDays = Math.floor((new Date(today) - new Date(lastDate)) / (1000 * 60 * 60 * 24));
            streakData.count = diffDays === 1 ? streakData.count + 1 : diffDays > 1 ? 0 : streakData.count;
        } else {
            streakData.count = 1;
        }
        streakData.lastDate = today;
        localStorage.setItem('streakData_v3', JSON.stringify(streakData));
    }
}

function updateStreakCounter() {
    document.getElementById('streakCount').textContent = streakData.count;
}

function updateStats() {
    document.getElementById('todayCount').textContent = todayLearned.length;
    document.getElementById('masteredCount').textContent = masteredWords.length;
    document.getElementById('totalCount').textContent = currentLibrary.vocabulary.length;
    document.getElementById('currentProgress').textContent = todayLearned.length;
    document.getElementById('dailyGoal').textContent = dailyGoal;
    document.getElementById('progressBar').style.width = Math.min((todayLearned.length / dailyGoal) * 100, 100) + '%';
}

function celebrateSuccess() {
    for (let i = 0; i < 30; i++) {
        setTimeout(() => {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            confetti.style.left = Math.random() * 100 + 'vw';
            confetti.style.backgroundColor = ['#f87171', '#fbbf24', '#34d399', '#60a5fa', '#a78bfa'][Math.floor(Math.random() * 5)];
            document.body.appendChild(confetti);
            setTimeout(() => confetti.remove(), 3000);
        }, i * 50);
    }
}

function switchTab(tab) {
    ['learn', 'quiz', 'stats'].forEach(t => {
        document.getElementById(t + '-section').classList.toggle('hidden', t !== tab);
        const btn = document.getElementById('tab-' + t);
        btn.className = t === tab ? 
            'flex-1 px-6 py-3 rounded-lg font-medium transition-all bg-gradient-to-r from-purple-600 to-pink-600 text-white' :
            'flex-1 px-6 py-3 rounded-lg font-medium transition-all text-gray-600 hover:bg-gray-50';
    });
    if (tab === 'quiz') loadQuiz();
}

// Initialize
init();
    </script>
</body>
</html>
